# OPA Policy for MCP Tool URL Blocking
# This policy blocks fetch_url tool calls to non-approved URLs
apiVersion: kuadrant.io/v1beta2
kind: AuthPolicy
metadata:
  name: mcp-tools-auth
  namespace: gateway-system
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: mcp-gateway
    sectionName: mcps
  rules:
    authentication:
      anonymous:
        anonymous: {}
    authorization:
      tool-policy:
        opa:
          allValues: true
          rego: |
            # Block fetch_url with unapproved URLs
            deny[msg] {
              input.context.request.http.body
              body := json.unmarshal(input.context.request.http.body)
              body.method == "tools/call"
              body.params.name == "fetch_url"
              url := body.params.arguments.url
              not approved_url(url)
              msg := sprintf("BLOCKED: URL '%s' not in approved list", [url])
            }

            # Block fetch_fetch_url (with prefix) 
            deny[msg] {
              input.context.request.http.body
              body := json.unmarshal(input.context.request.http.body)
              body.method == "tools/call"
              body.params.name == "fetch_fetch_url"
              url := body.params.arguments.url
              not approved_url(url)
              msg := sprintf("BLOCKED: URL '%s' not in approved list", [url])
            }
            
            # IMDS protection
            deny[msg] {
              input.context.request.http.body
              body := json.unmarshal(input.context.request.http.body)
              body.method == "tools/call"
              url := body.params.arguments.url
              startswith(url, "http://169.254.169.254")
              msg := "BLOCKED: IMDS access not permitted"
            }
            
            # Approved URL patterns
            approved_url(url) { startswith(url, "https://api.weather.gov") }
            approved_url(url) { startswith(url, "https://httpbin.org") }
            approved_url(url) { startswith(url, "https://example.com") }
            approved_url(url) { startswith(url, "https://api.github.com") }
            
            allow { count(deny) == 0 }
