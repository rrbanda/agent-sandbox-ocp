# AuthPolicy for MCP Gateway URL Blocking
# Blocks tool calls to non-approved URLs and restricted parameters
apiVersion: kuadrant.io/v1beta2
kind: AuthPolicy
metadata:
  name: mcp-tools-auth
  namespace: gateway-system
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: mcp-gateway
    sectionName: mcps
  rules:
    authentication:
      "anonymous":
        anonymous: {}
    authorization:
      "tool-policy":
        opa:
          rego: |
            package authorino.authz

            # Allow if no denials
            allow { count(deny) == 0 }

            # Block fetch_url calls to non-approved URLs
            deny[msg] {
              input.context.request.http.body
              body := json.unmarshal(input.context.request.http.body)
              body.method == "tools/call"
              body.params.name == "fetch_url"
              url := body.params.arguments.url
              not approved_url(url)
              msg := sprintf("BLOCKED: URL '%s' not in approved list", [url])
            }

            # Block weather queries for restricted cities
            deny[msg] {
              input.context.request.http.body
              body := json.unmarshal(input.context.request.http.body)
              body.method == "tools/call"
              startswith(body.params.name, "weather_")
              city := lower(body.params.arguments.city)
              restricted_city(city)
              msg := sprintf("BLOCKED: Weather for '%s' is restricted", [city])
            }

            # Approved URL patterns
            approved_url(url) { startswith(url, "https://api.weather.gov") }
            approved_url(url) { startswith(url, "https://httpbin.org") }
            approved_url(url) { startswith(url, "https://example.com") }
            approved_url(url) { startswith(url, "https://api.github.com") }

            # Restricted cities
            restricted_city("moscow")
            restricted_city("beijing")
            restricted_city("pyongyang")
          allValues: true
